<Window x:Class="SpotiffyWidget.MainWindow"
           xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
           xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
           xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
           xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
           xmlns:hc="https://handyorg.github.io/handycontrol"
           xmlns:cards="clr-namespace:SpotiffyWidget.Cards"
           mc:Ignorable="d"
           Title="Spotify Desktop Widget"
           WindowStartupLocation="CenterScreen"
           Height="770"
           Width="450"
           MinHeight="650"
           MinWidth="400"
           MaxHeight = "900"
           MaxWidth = "600"
           ShowInTaskbar="False"
           WindowStyle="None"
           AllowsTransparency="True"
           Background="Transparent"
           ResizeMode="CanResize"
           Loaded="Window_Loaded">

    <WindowChrome.WindowChrome>
        <WindowChrome CaptionHeight="40"
                      ResizeBorderThickness="5"
                      GlassFrameThickness="0" />
    </WindowChrome.WindowChrome>

    <Window.Resources>
        
        <Style x:Key="DynamicHeightListBoxItem" TargetType="ListBoxItem">
            <Setter Property="Padding" Value="0" />
            <Setter Property="Margin" Value="10,2,2,2" />
            <Setter Property="MaxHeight" Value="110" />
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListBoxItem">
                        <Border x:Name="Bd"
                                Background="{TemplateBinding Background}"
                                BorderBrush="{TemplateBinding BorderBrush}"
                                BorderThickness="{TemplateBinding BorderThickness}"
                                MaxHeight="{TemplateBinding MaxHeight}"
                                Padding="{TemplateBinding Padding}"
                                CornerRadius="5"
                                SnapsToDevicePixels="true">
                            <VisualStateManager.VisualStateGroups>
                                <VisualStateGroup x:Name="ViewStates">
                                    <VisualState x:Name="NormalView">
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetName="Bd"
                                                             Storyboard.TargetProperty="MaxHeight" To="110"
                                                             Duration="0:0:0.2" />
                                        </Storyboard>
                                    </VisualState>
                                    <VisualState x:Name="CompactView">
                                        <Storyboard>
                                            <DoubleAnimation Storyboard.TargetName="Bd"
                                                             Storyboard.TargetProperty="MaxHeight" To="65"
                                                             Duration="0:0:0.2" />
                                        </Storyboard>
                                    </VisualState>
                                </VisualStateGroup>
                            </VisualStateManager.VisualStateGroups>
                            <ContentPresenter HorizontalAlignment="{TemplateBinding HorizontalContentAlignment}"
                                              SnapsToDevicePixels="{TemplateBinding SnapsToDevicePixels}"
                                              VerticalAlignment="{TemplateBinding VerticalContentAlignment}" />
                        </Border>
                        <ControlTemplate.Triggers>
                            <!-- Kural 1: Öğe seçili DEĞİLKEN fare üzerine gelirse, gri yap -->
                            <MultiTrigger>
                                <MultiTrigger.Conditions>
                                    <Condition Property="IsMouseOver" Value="True" />
                                    <Condition Property="IsSelected" Value="False" />
                                </MultiTrigger.Conditions>
                                <Setter TargetName="Bd" Property="Background" Value="{DynamicResource SecondaryRegionBrush}" />
                            </MultiTrigger>

                            <!-- Kural 2: Öğe seçili ise (fare üzerinde olsun veya olmasın), ana tema rengi yap -->
                            <MultiTrigger>
                                <MultiTrigger.Conditions>
                                    <Condition Property="IsSelected" Value="True" />
                                </MultiTrigger.Conditions>
                                <Setter TargetName="Bd" Property="Background" Value="{DynamicResource PrimaryBrush}" />
                            </MultiTrigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>
    
    <Border Background="{DynamicResource RegionBrush}" CornerRadius="10" ClipToBounds="True" BorderThickness="0">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="40"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Title Bar Panel -->
            <Border x:Name="TitleBarBorder" Grid.Row="0" Background="{DynamicResource RegionBrush}" CornerRadius="10,10,0,0" 
                    BorderThickness="0"
                    MouseLeftButtonDown="TitleBar_MouseLeftButtonDown">
                <Grid>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Left" VerticalAlignment="Center">
                        <Menu Padding="10,0,0,0" Background="Transparent" WindowChrome.IsHitTestVisibleInChrome="True">
                            <MenuItem Style="{StaticResource MenuItemBaseStyle}" Foreground="{DynamicResource PrimaryTextBrush}">
                                <MenuItem.Icon>
                                    <Viewbox>
                                        <Path Data="{DynamicResource ConfigGeometry}" Fill="{DynamicResource PrimaryTextBrush}"/>
                                    </Viewbox>
                                </MenuItem.Icon>

                                <MenuItem Header="View Settings">
                                    <CheckBox x:Name="AlwaysOnTopCB" Click="AlwaysOnTopCB_Click">Always On Top</CheckBox>
                                    <CheckBox x:Name="PlaceOnDesktopCB" Click="PlaceOnDesktopCB_Click">Place On Desktop</CheckBox>
                                </MenuItem>
                                <MenuItem Header="Playback Settings">
                                    <CheckBox x:Name="StopMusicCB" Click="StopMusicCB_Click">Stop when session is locked</CheckBox>
                                    <CheckBox x:Name="PowerModeCB" Click="PreventSleepMode_Click">Prevent Sleep Mode</CheckBox>
                                </MenuItem>
                                <CheckBox x:Name="OpenSpotifyCB" Click="OpenSpotifyCB_Click">Open Spotify at Start</CheckBox>
                            </MenuItem>
                        </Menu>
                        
                        <Button Click="ChangeTheme" 
                               Style="{StaticResource ButtonIcon}" Foreground="{DynamicResource PrimaryTextBrush}"
                               hc:IconElement.Geometry="{StaticResource PaletteIcon}"
                               WindowChrome.IsHitTestVisibleInChrome="True" />

                        <Button Click="ChangeSizeClick" Width="36"
                               Style="{StaticResource ButtonIcon}" Foreground="{DynamicResource PrimaryTextBrush}"
                               hc:IconElement.Geometry="{StaticResource MinimizeIcon}"
                               WindowChrome.IsHitTestVisibleInChrome="True" />
                    </StackPanel>
                    
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="0,0,10,0">
                        <Button Click="Button_Close" Width="36" Height="30" Content="✕"
                               Style="{StaticResource ButtonIcon}" Foreground="{DynamicResource PrimaryTextBrush}"
                               FontSize="16"
                               WindowChrome.IsHitTestVisibleInChrome="True" />
                    </StackPanel>
                    
                    <Popup PlacementTarget="{Binding ElementName=ButtonConfig}" AllowsTransparency="True"
                           HorizontalOffset="-35" x:Name="PopupConfig" VerticalOffset="6" StaysOpen="False">
                        <Border Background="{DynamicResource SecondaryRegionBrush}" CornerRadius="4" Margin="16"
                                Effect="{StaticResource EffectShadow2}">
                            <StackPanel Button.Click="ButtonSkins_OnClick">
                                <hc:Divider Width="200" Margin="0,10" Content="Application Theme" />
                                <StackPanel HorizontalAlignment="Center" Orientation="Horizontal">
                                    <Button Tag="{x:Static hc:ApplicationTheme.Light}" Style="{StaticResource ButtonCustom}">
                                        <Border Background="White" Width="32" Height="21" CornerRadius="2" BorderThickness="1"
                                                BorderBrush="{DynamicResource BorderBrush}" />
                                    </Button>
                                    <Button Tag="{x:Static hc:ApplicationTheme.Dark}" Style="{StaticResource ButtonCustom}"
                                            Margin="10,0,0,0">
                                        <Border Background="Black" Width="32" Height="21" CornerRadius="2" BorderThickness="1"
                                                BorderBrush="{DynamicResource BorderBrush}" />
                                    </Button>
                                </StackPanel>
                                
                                <hc:Divider Width="200" Margin="0,10" Content="Accent Color" />
                                <StackPanel Margin="0,0,0,10" HorizontalAlignment="Center" Orientation="Horizontal">
                                    <Button Tag="{Binding ElementName=primaryBorder, Path=Background}"
                                            Style="{StaticResource ButtonCustom}">
                                        <Border Name="primaryBorder" Background="#2196F3" Width="32" Height="21"
                                                CornerRadius="2" BorderThickness="1"
                                                BorderBrush="{DynamicResource BorderBrush}" />
                                    </Button>
                                    <Button Tag="{Binding ElementName=warningBorder, Path=Background}"
                                            Style="{StaticResource ButtonCustom}" Margin="10,0,0,0">
                                        <Border Name="warningBorder" Background="Orange" Width="32"
                                                Height="21" CornerRadius="2" BorderThickness="1"
                                                BorderBrush="{DynamicResource BorderBrush}" />
                                    </Button>
                                    <Button Tag="{Binding ElementName=violetBorder, Path=Background}"
                                            Style="{StaticResource ButtonCustom}" Margin="10,0,0,0">
                                        <Border Name="violetBorder" Background="#9C27B0" Width="32" Height="21"
                                                CornerRadius="2" BorderThickness="1"
                                                BorderBrush="{DynamicResource BorderBrush}" />
                                    </Button>
                                    <Button Tag="{Binding ElementName=successBorder, Path=Background}"
                                            Style="{StaticResource ButtonCustom}" Margin="10,0,0,0">
                                        <Border Name="successBorder" Background="ForestGreen" Width="32"
                                                Height="21" CornerRadius="2" BorderThickness="1"
                                                BorderBrush="{DynamicResource BorderBrush}" />
                                    </Button>
                                </StackPanel>

                                <Button HorizontalAlignment="Stretch" Tag="Picker" Content="More Colors" Margin="10" />
                            </StackPanel>
                        </Border>
                    </Popup>
                </Grid>
            </Border>

            <!-- Main Content -->
            <Border Grid.Row="1" Padding="5">
                <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="1*" />

            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <RowDefinition Height="1" />
                <RowDefinition x:Name="PlayerRow" Height="20*" />
                <RowDefinition Height="5" />
                <RowDefinition x:Name="TabRow" Height="40*"/>
            </Grid.RowDefinitions>

            <hc:TransitioningContentControl x:Name="LoadingPanel" Visibility="Collapsed" TransitionMode="Fade"
                                            Grid.Column="0" Grid.Row="3" Panel.ZIndex="11">
                <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                    <hc:LoadingCircle Width="30" Height="30" DotSpeed="4" DotCount="5" />
                    <TextBlock Text="Loading..."
                               Margin="0,0,0,0"
                               FontSize="14"
                               HorizontalAlignment="Center" Foreground="{DynamicResource PrimaryTextBrush}"/>
                </StackPanel>       
            </hc:TransitioningContentControl>

            <Border x:Name="PlayerBorder" Grid.Column="0" Grid.Row="1" Padding="0" 
                    CornerRadius="5" BorderThickness="1" BorderBrush="{DynamicResource BorderBrush}" 
                    Background="Transparent">
                <cards:PlayerCard x:Name="PlayerCard"/>
            </Border>

            <Border x:Name="TabsBorder" Grid.Row="3" Grid.Column="0" 
                    CornerRadius="5" BorderThickness="1" BorderBrush="{DynamicResource BorderBrush}" 
                    Background="Transparent" Padding="0">
                <Frame x:Name="TabsFrame" NavigationUIVisibility="Hidden" BorderBrush="{x:Null}" Navigated="TabsFrame_Navigated"/>
            </Border>


            <hc:NotifyIcon x:Name="TrayIcon" Text="SpotifyWidGet"
                         Margin="0,156,399,52" Grid.Row="2" MouseDoubleClick="MenuItemOpen" >
   
                
                <hc:NotifyIcon.ContextMenu>
                    <ContextMenu>
                        <MenuItem Click="MenuItemOpen" Header="Open"/>
                        <MenuItem Command="hc:ControlCommands.ShutdownApp" Header="Exit"/>
                    </ContextMenu>
                </hc:NotifyIcon.ContextMenu>

       
                    </hc:NotifyIcon>
                </Grid>
            </Border>

            <!-- Mini Player - Tüm pencereyi kaplar (Title Bar + Content) -->
            <Border x:Name="MiniPlayerBorder" Visibility="Collapsed" 
                    Grid.Row="0" Grid.RowSpan="2" CornerRadius="10" 
                    BorderThickness="1" BorderBrush="{DynamicResource BorderBrush}" 
                    Background="Transparent" Panel.ZIndex="10" Padding="5">
                <cards:MiniPlayerCard x:Name="MiniPlayerCard" />
            </Border>
        </Grid>
    </Border>
</Window>
